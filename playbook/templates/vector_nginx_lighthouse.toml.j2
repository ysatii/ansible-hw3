# üìå –ò—Å—Ç–æ—á–Ω–∏–∫ –ª–æ–≥–æ–≤ –∏–∑ —Ñ–∞–π–ª–æ–≤
[sources.nginx_logs]
type = "file"
include = ["/var/log/nginx/access.log", "/var/log/nginx/error.log"]
read_from = "beginning"

# üìå –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤
[transforms.parse_logs]
type = "remap"
inputs = ["nginx_logs"]
source = '''
.timestamp, err = format_timestamp(now(), "%Y-%m-%d %H:%M:%S")
.host = get_env_var("HOSTNAME") ?? "lighthouse"
.log_type = "nginx"
'''

# üìå –§–∏–ª—å—Ç—Ä –ø—É—Å—Ç—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
[transforms.filter_empty_logs]
type = "filter"
inputs = ["parse_logs"]
condition = '''
exists(.message) && .message != ""
'''

# üìå –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–≥–æ–≤ –≤ –¥—Ä—É–≥–æ–π Vector (compute-vm-clickhouse2)
[sinks.vector_sink]
type = "vector"
inputs = ["filter_empty_logs"]  # –û–±–Ω–æ–≤–ª–µ–Ω–æ! –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π input
address = "{{ hostvars['vector-02'].ansible_host }}:6000"   
batch.max_bytes = 1048576
batch.timeout_secs = 5
version = "2"

# üìå –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ–±–∞–≥–∞
[sinks.debug_output]
type = "console"
inputs = ["filter_empty_logs"]  # –û–±–Ω–æ–≤–ª–µ–Ω–æ! –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π input
encoding.codec = "json"
